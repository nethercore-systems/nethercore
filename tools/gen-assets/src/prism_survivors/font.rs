//! Font generation for PRISM SURVIVORS
//!
//! Custom 8x12 bitmap font atlas with cyan/purple color scheme

use proc_gen::texture::{write_png, TextureBuffer};
use std::path::Path;

/// Generates a custom 8x12 bitmap font atlas for PRISM SURVIVORS
/// 96 ASCII characters (32-127) in a 128x72 texture
pub fn generate(output_dir: &Path) {
    println!("  Generating: prism_font.png");

    const GLYPH_W: usize = 8;
    const GLYPH_H: usize = 12;
    const CHARS_PER_ROW: usize = 16;
    const NUM_CHARS: usize = 96;
    const NUM_ROWS: usize = (NUM_CHARS + CHARS_PER_ROW - 1) / CHARS_PER_ROW; // 6 rows
    const TEX_W: usize = CHARS_PER_ROW * GLYPH_W; // 128
    const TEX_H: usize = NUM_ROWS * GLYPH_H;      // 72

    // PRISM SURVIVORS color scheme - cyan primary, purple glow
    let fg: [u8; 4] = [0, 255, 255, 255];      // Cyan
    let glow: [u8; 4] = [180, 100, 255, 255];  // Purple glow
    let bg: [u8; 4] = [0, 0, 0, 0];            // Transparent

    // 8x12 pixel font glyphs (ASCII 32-127)
    // Each glyph is 12 rows of 8 bits
    #[rustfmt::skip]
    const GLYPHS: [[u8; 12]; 96] = [
        // 32 SPACE
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        // 33 !
        [0x00, 0x18, 0x18, 0x18, 0x18, 0x18, 0x18, 0x00, 0x18, 0x18, 0x00, 0x00],
        // 34 "
        [0x00, 0x6C, 0x6C, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        // 35 #
        [0x00, 0x00, 0x24, 0x24, 0x7E, 0x24, 0x7E, 0x24, 0x24, 0x00, 0x00, 0x00],
        // 36 $
        [0x00, 0x10, 0x3C, 0x50, 0x38, 0x14, 0x78, 0x10, 0x00, 0x00, 0x00, 0x00],
        // 37 %
        [0x00, 0x00, 0x62, 0x64, 0x08, 0x10, 0x26, 0x46, 0x00, 0x00, 0x00, 0x00],
        // 38 &
        [0x00, 0x30, 0x48, 0x48, 0x30, 0x4A, 0x44, 0x3A, 0x00, 0x00, 0x00, 0x00],
        // 39 '
        [0x00, 0x18, 0x18, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        // 40 (
        [0x00, 0x08, 0x10, 0x20, 0x20, 0x20, 0x20, 0x10, 0x08, 0x00, 0x00, 0x00],
        // 41 )
        [0x00, 0x20, 0x10, 0x08, 0x08, 0x08, 0x08, 0x10, 0x20, 0x00, 0x00, 0x00],
        // 42 *
        [0x00, 0x00, 0x24, 0x18, 0x7E, 0x18, 0x24, 0x00, 0x00, 0x00, 0x00, 0x00],
        // 43 +
        [0x00, 0x00, 0x00, 0x18, 0x18, 0x7E, 0x18, 0x18, 0x00, 0x00, 0x00, 0x00],
        // 44 ,
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x08, 0x10, 0x00],
        // 45 -
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        // 46 .
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00],
        // 47 /
        [0x00, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x80, 0x00, 0x00, 0x00, 0x00],
        // 48 0
        [0x00, 0x3C, 0x46, 0x4A, 0x4A, 0x52, 0x52, 0x62, 0x3C, 0x00, 0x00, 0x00],
        // 49 1
        [0x00, 0x08, 0x18, 0x28, 0x08, 0x08, 0x08, 0x08, 0x3E, 0x00, 0x00, 0x00],
        // 50 2
        [0x00, 0x3C, 0x42, 0x02, 0x0C, 0x30, 0x40, 0x40, 0x7E, 0x00, 0x00, 0x00],
        // 51 3
        [0x00, 0x3C, 0x42, 0x02, 0x1C, 0x02, 0x02, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 52 4
        [0x00, 0x04, 0x0C, 0x14, 0x24, 0x44, 0x7E, 0x04, 0x04, 0x00, 0x00, 0x00],
        // 53 5
        [0x00, 0x7E, 0x40, 0x40, 0x7C, 0x02, 0x02, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 54 6
        [0x00, 0x1C, 0x20, 0x40, 0x7C, 0x42, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 55 7
        [0x00, 0x7E, 0x02, 0x04, 0x08, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00],
        // 56 8
        [0x00, 0x3C, 0x42, 0x42, 0x3C, 0x42, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 57 9
        [0x00, 0x3C, 0x42, 0x42, 0x42, 0x3E, 0x02, 0x04, 0x38, 0x00, 0x00, 0x00],
        // 58 :
        [0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x00],
        // 59 ;
        [0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x18, 0x08, 0x10, 0x00],
        // 60 <
        [0x00, 0x00, 0x04, 0x08, 0x10, 0x20, 0x10, 0x08, 0x04, 0x00, 0x00, 0x00],
        // 61 =
        [0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00],
        // 62 >
        [0x00, 0x00, 0x20, 0x10, 0x08, 0x04, 0x08, 0x10, 0x20, 0x00, 0x00, 0x00],
        // 63 ?
        [0x00, 0x3C, 0x42, 0x02, 0x04, 0x08, 0x08, 0x00, 0x08, 0x08, 0x00, 0x00],
        // 64 @
        [0x00, 0x3C, 0x42, 0x4E, 0x52, 0x4E, 0x40, 0x40, 0x3C, 0x00, 0x00, 0x00],
        // 65 A
        [0x00, 0x18, 0x24, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x00, 0x00, 0x00],
        // 66 B
        [0x00, 0x7C, 0x42, 0x42, 0x7C, 0x42, 0x42, 0x42, 0x7C, 0x00, 0x00, 0x00],
        // 67 C
        [0x00, 0x3C, 0x42, 0x40, 0x40, 0x40, 0x40, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 68 D
        [0x00, 0x78, 0x44, 0x42, 0x42, 0x42, 0x42, 0x44, 0x78, 0x00, 0x00, 0x00],
        // 69 E
        [0x00, 0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x7E, 0x00, 0x00, 0x00],
        // 70 F
        [0x00, 0x7E, 0x40, 0x40, 0x7C, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00],
        // 71 G
        [0x00, 0x3C, 0x42, 0x40, 0x40, 0x4E, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 72 H
        [0x00, 0x42, 0x42, 0x42, 0x7E, 0x42, 0x42, 0x42, 0x42, 0x00, 0x00, 0x00],
        // 73 I
        [0x00, 0x3E, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x3E, 0x00, 0x00, 0x00],
        // 74 J
        [0x00, 0x1E, 0x04, 0x04, 0x04, 0x04, 0x04, 0x44, 0x38, 0x00, 0x00, 0x00],
        // 75 K
        [0x00, 0x42, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x42, 0x00, 0x00, 0x00],
        // 76 L
        [0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7E, 0x00, 0x00, 0x00],
        // 77 M
        [0x00, 0x42, 0x66, 0x5A, 0x5A, 0x42, 0x42, 0x42, 0x42, 0x00, 0x00, 0x00],
        // 78 N
        [0x00, 0x42, 0x62, 0x52, 0x4A, 0x46, 0x42, 0x42, 0x42, 0x00, 0x00, 0x00],
        // 79 O
        [0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 80 P
        [0x00, 0x7C, 0x42, 0x42, 0x7C, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00],
        // 81 Q
        [0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x4A, 0x44, 0x3A, 0x00, 0x00, 0x00],
        // 82 R
        [0x00, 0x7C, 0x42, 0x42, 0x7C, 0x48, 0x44, 0x42, 0x42, 0x00, 0x00, 0x00],
        // 83 S
        [0x00, 0x3C, 0x42, 0x40, 0x3C, 0x02, 0x02, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 84 T
        [0x00, 0x7F, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00],
        // 85 U
        [0x00, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 86 V
        [0x00, 0x42, 0x42, 0x42, 0x42, 0x42, 0x24, 0x24, 0x18, 0x00, 0x00, 0x00],
        // 87 W
        [0x00, 0x42, 0x42, 0x42, 0x42, 0x5A, 0x5A, 0x66, 0x42, 0x00, 0x00, 0x00],
        // 88 X
        [0x00, 0x42, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x42, 0x00, 0x00, 0x00],
        // 89 Y
        [0x00, 0x41, 0x22, 0x14, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00, 0x00],
        // 90 Z
        [0x00, 0x7E, 0x02, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7E, 0x00, 0x00, 0x00],
        // 91 [
        [0x00, 0x1C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x1C, 0x00, 0x00, 0x00],
        // 92 backslash
        [0x00, 0x80, 0x40, 0x20, 0x10, 0x08, 0x04, 0x02, 0x00, 0x00, 0x00, 0x00],
        // 93 ]
        [0x00, 0x38, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x38, 0x00, 0x00, 0x00],
        // 94 ^
        [0x00, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        // 95 _
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00],
        // 96 `
        [0x00, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        // 97 a
        [0x00, 0x00, 0x00, 0x3C, 0x02, 0x3E, 0x42, 0x42, 0x3E, 0x00, 0x00, 0x00],
        // 98 b
        [0x00, 0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x62, 0x5C, 0x00, 0x00, 0x00],
        // 99 c
        [0x00, 0x00, 0x00, 0x3C, 0x42, 0x40, 0x40, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 100 d
        [0x00, 0x02, 0x02, 0x3A, 0x46, 0x42, 0x42, 0x46, 0x3A, 0x00, 0x00, 0x00],
        // 101 e
        [0x00, 0x00, 0x00, 0x3C, 0x42, 0x7E, 0x40, 0x40, 0x3C, 0x00, 0x00, 0x00],
        // 102 f
        [0x00, 0x0C, 0x10, 0x10, 0x3C, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00],
        // 103 g
        [0x00, 0x00, 0x00, 0x3A, 0x46, 0x42, 0x46, 0x3A, 0x02, 0x42, 0x3C, 0x00],
        // 104 h
        [0x00, 0x40, 0x40, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x42, 0x00, 0x00, 0x00],
        // 105 i
        [0x00, 0x08, 0x00, 0x18, 0x08, 0x08, 0x08, 0x08, 0x1C, 0x00, 0x00, 0x00],
        // 106 j
        [0x00, 0x04, 0x00, 0x0C, 0x04, 0x04, 0x04, 0x04, 0x04, 0x44, 0x38, 0x00],
        // 107 k
        [0x00, 0x40, 0x40, 0x44, 0x48, 0x70, 0x48, 0x44, 0x42, 0x00, 0x00, 0x00],
        // 108 l
        [0x00, 0x18, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x1C, 0x00, 0x00, 0x00],
        // 109 m
        [0x00, 0x00, 0x00, 0x76, 0x49, 0x49, 0x49, 0x49, 0x49, 0x00, 0x00, 0x00],
        // 110 n
        [0x00, 0x00, 0x00, 0x5C, 0x62, 0x42, 0x42, 0x42, 0x42, 0x00, 0x00, 0x00],
        // 111 o
        [0x00, 0x00, 0x00, 0x3C, 0x42, 0x42, 0x42, 0x42, 0x3C, 0x00, 0x00, 0x00],
        // 112 p
        [0x00, 0x00, 0x00, 0x5C, 0x62, 0x42, 0x62, 0x5C, 0x40, 0x40, 0x40, 0x00],
        // 113 q
        [0x00, 0x00, 0x00, 0x3A, 0x46, 0x42, 0x46, 0x3A, 0x02, 0x02, 0x02, 0x00],
        // 114 r
        [0x00, 0x00, 0x00, 0x5C, 0x62, 0x40, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00],
        // 115 s
        [0x00, 0x00, 0x00, 0x3E, 0x40, 0x3C, 0x02, 0x02, 0x7C, 0x00, 0x00, 0x00],
        // 116 t
        [0x00, 0x10, 0x10, 0x3C, 0x10, 0x10, 0x10, 0x10, 0x0C, 0x00, 0x00, 0x00],
        // 117 u
        [0x00, 0x00, 0x00, 0x42, 0x42, 0x42, 0x42, 0x46, 0x3A, 0x00, 0x00, 0x00],
        // 118 v
        [0x00, 0x00, 0x00, 0x42, 0x42, 0x42, 0x24, 0x24, 0x18, 0x00, 0x00, 0x00],
        // 119 w
        [0x00, 0x00, 0x00, 0x41, 0x49, 0x49, 0x49, 0x49, 0x36, 0x00, 0x00, 0x00],
        // 120 x
        [0x00, 0x00, 0x00, 0x42, 0x24, 0x18, 0x18, 0x24, 0x42, 0x00, 0x00, 0x00],
        // 121 y
        [0x00, 0x00, 0x00, 0x42, 0x42, 0x42, 0x46, 0x3A, 0x02, 0x42, 0x3C, 0x00],
        // 122 z
        [0x00, 0x00, 0x00, 0x7E, 0x04, 0x08, 0x10, 0x20, 0x7E, 0x00, 0x00, 0x00],
        // 123 {
        [0x00, 0x0C, 0x10, 0x10, 0x10, 0x20, 0x10, 0x10, 0x10, 0x0C, 0x00, 0x00],
        // 124 |
        [0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00, 0x00],
        // 125 }
        [0x00, 0x30, 0x08, 0x08, 0x08, 0x04, 0x08, 0x08, 0x08, 0x30, 0x00, 0x00],
        // 126 ~
        [0x00, 0x00, 0x00, 0x00, 0x32, 0x4C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
        // 127 DEL (empty)
        [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00],
    ];

    // Create texture buffer
    let mut pixels = vec![[0u8; 4]; TEX_W * TEX_H];

    // Render each glyph
    for (i, glyph) in GLYPHS.iter().enumerate() {
        let col = i % CHARS_PER_ROW;
        let row = i / CHARS_PER_ROW;
        let base_x = col * GLYPH_W;
        let base_y = row * GLYPH_H;

        for (gy, &bits) in glyph.iter().enumerate() {
            for gx in 0..8 {
                let px = base_x + gx;
                let py = base_y + gy;
                let idx = py * TEX_W + px;

                if (bits >> (7 - gx)) & 1 == 1 {
                    pixels[idx] = fg;
                } else {
                    // Check if adjacent to a lit pixel for glow effect
                    let mut has_neighbor = false;
                    for dy in -1i32..=1 {
                        for dx in -1i32..=1 {
                            if dx == 0 && dy == 0 { continue; }
                            let nx = gx as i32 + dx;
                            let ny = gy as i32 + dy;
                            if nx >= 0 && nx < 8 && ny >= 0 && ny < 12 {
                                let neighbor_bits = glyph[ny as usize];
                                if (neighbor_bits >> (7 - nx)) & 1 == 1 {
                                    has_neighbor = true;
                                    break;
                                }
                            }
                        }
                        if has_neighbor { break; }
                    }
                    pixels[idx] = if has_neighbor { glow } else { bg };
                }
            }
        }
    }

    // Write to file
    let path = output_dir.join("prism_font.png");
    let flat: Vec<u8> = pixels.iter().flat_map(|p| p.iter().copied()).collect();
    let tex = TextureBuffer {
        width: TEX_W as u32,
        height: TEX_H as u32,
        pixels: flat,
    };
    write_png(&tex, &path).expect("Failed to write font PNG");
    println!("    -> {} ({}x{}, {} glyphs)", path.display(), TEX_W, TEX_H, NUM_CHARS);
}
